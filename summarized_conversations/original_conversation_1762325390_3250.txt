{'role': 'assistant', 'content': '<function_calls>\n<full-file-rewrite file_path="HEX-Control-Nexus/backend/node_webhooks/puppeteer_tasks.js">\nconst puppeteer = require(\'puppeteer\');\nconst fs = require(\'fs\').promises;\nconst path = require(\'path\');\n\n// Ensure screenshots directory exists\nasync function ensureScreenshotsDir() {\n  const screenshotsDir = path.join(__dirname, \'..\', \'..\', \'logs\', \'screenshots\');\n  try {\n    await fs.access(screenshotsDir);\n  } catch {\n    await fs.mkdir(screenshotsDir, { recursive: true });\n  }\n  return screenshotsDir;\n}\n\nasync function triggerPuppeteerTask(target, options = {}) {\n  let browser;\n  let page;\n  \n  try {\n    // Ensure screenshots directory exists\n    const screenshotsDir = await ensureScreenshotsDir();\n    \n    // Launch browser\n    browser = await puppeteer.launch({\n      headless: options.headless !== false, // Default to headless\n      args: [\n        \'--no-sandbox\',\n        \'--disable-setuid-sandbox\',\n        \'--disable-dev-shm-usage\'\n      ]\n    });\n    \n    // Create a new page\n    page = await browser.newPage();\n    \n    // Set viewport\n    await page.setViewport({ \n      width: 1920, \n      height: 1080,\n      deviceScaleFactor: 1\n    });\n    \n    // Set user agent\n    await page.setUserAgent(\'Mozilla/5.0 (compatible; HEX/1.0; +http://example.com/bot)\');\n    \n    // Navigate to target\n    console.log(`Navigating to: ${target}`);\n    await page.goto(target, { \n      waitUntil: \'networkidle2\',\n      timeout: 30000\n    });\n    \n    // Wait for specific selector if provided\n    if (options.waitForSelector) {\n      await page.waitForSelector(options.waitForSelector, { timeout: 10000 });\n    }\n    \n    // Take screenshot if requested\n    let screenshotPath = null;\n    if (options.screenshot !== false) {\n      const timestamp = new Date().toISOString().replace(/[:.]/g, \'-\');\n      screenshotPath = path.join(screenshotsDir, `screenshot_${timestamp}.png`);\n      await page.screenshot({ path: screenshotPath, fullPage: true });\n    }\n    \n    // Extract data if selectors provided\n    let extractedData = {};\n    if (options.selectors) {\n      extractedData = await page.evaluate((selectors) => {\n        const result = {};\n        for (const [key, selector] of Object.entries(selectors)) {\n          try {\n            const element = document.querySelector(selector);\n            if (element) {\n              result[key] = element.textContent.trim();\n            }\n          } catch (error) {\n            result[key] = `Error: ${error.message}`;\n          }\n        }\n        return result;\n      }, options.selectors);\n    }\n    \n    // Close browser\n    await browser.close();\n    \n    return {\n      success: true,\n      message: \'Puppeteer task completed successfully\',\n      url: target,\n      title: await page.title(),\n      screenshot: screenshotPath,\n      data: extractedData\n    };\n    \n  } catch (error) {\n    // Take screenshot on error if possible\n    if (browser && page) {\n      try {\n        const screenshotsDir = await ensureScreenshotsDir();\n        const timestamp = new Date().toISOString().replace(/[:.]/g, \'-\');\n        const errorScreenshotPath = path.join(screenshotsDir, `error_${timestamp}.png`);\n        await page.screenshot({ path: errorScreenshotPath, fullPage: true });\n        console.log(`Error screenshot saved to: ${errorScreenshotPath}`);\n      } catch (screenshotError) {\n        console.error(\'Failed to take error screenshot:\', screenshotError);\n      }\n    }\n    \n    // Close browser if it\'s still open\n    if (browser) {\n      try {\n        await browser.close();\n      } catch (closeError) {\n        console.error(\'Failed to close browser:\', closeError);\n      }\n    }\n    \n    throw new Error(`Puppeteer task failed: ${error.message}`);\n  }\n}\n\n// Example usage function\nasync function runExampleTask() {\n  try {\n    const result = await triggerPuppeteerTask(\'https://example.com\', {\n      headless: true,\n      waitForSelector: \'h1\',\n      selectors: {\n        title: \'h1\',\n        paragraph: \'p\'\n      },\n      screenshot: true\n    });\n    \n    console.log(\'Task result:\', result);\n    return result;\n  } catch...\n The full message content is stored at /workspace/summarized_conversations/original_conversation_1762325215_9552.txt'}