{'role': 'assistant', 'content': '<function_calls>\n<create-file file_path="HEX-Control-Nexus/backend/node_webhooks/puppeteer_tasks.js">\nconst puppeteer = require(\'puppeteer\');\nconst fs = require(\'fs\').promises;\nconst path = require(\'path\');\n\n// Ensure screenshots directory exists\nasync function ensureScreenshotsDir() {\n    const screenshotsDir = path.join(__dirname, \'..\', \'..\', \'logs\', \'screenshots\');\n    try {\n        await fs.mkdir(screenshotsDir, { recursive: true });\n    } catch (error) {\n        console.warn(\'Could not create screenshots directory:\', error.message);\n    }\n    return screenshotsDir;\n}\n\n// Take screenshot with error handling\nasync function takeScreenshot(page, name) {\n    const screenshotsDir = await ensureScreenshotsDir();\n    const timestamp = new Date().toISOString().replace(/[:.]/g, \'-\');\n    const screenshotPath = path.join(screenshotsDir, `${name}_${timestamp}.png`);\n    \n    try {\n        await page.screenshot({ path: screenshotPath, fullPage: true });\n        return screenshotPath;\n    } catch (error) {\n        console.warn(`Could not take screenshot ${name}:`, error.message);\n        return null;\n    }\n}\n\n// Main function to trigger Puppeteer tasks\nasync function triggerPuppeteerTask(target, options = {}) {\n    let browser = null;\n    \n    try {\n        // Ensure screenshots directory exists\n        await ensureScreenshotsDir();\n        \n        // Launch browser\n        browser = await puppeteer.launch({\n            headless: true,\n            args: [\n                \'--no-sandbox\',\n                \'--disable-setuid-sandbox\',\n                \'--disable-dev-shm-usage\'\n            ]\n        });\n        \n        const page = await browser.newPage();\n        await page.setViewport({ width: 1280, height: 800 });\n        \n        // Navigate to target\n        await page.goto(target, { \n            waitUntil: \'networkidle2\',\n            timeout: 30000\n        });\n        \n        // Take initial screenshot\n        const initialScreenshot = await takeScreenshot(page, \'initial\');\n        \n        // Extract data based on options\n        let extractedData = {};\n        \n        if (options.selectors) {\n            // Extract data using selectors\n            for (const [key, selector] of Object.entries(options.selectors)) {\n                try {\n                    if (selector.endsWith(\'::text\')) {\n                        // Extract text content\n                        const cleanSelector = selector.replace(\'::text\', \'\');\n                        extractedData[key] = await page.$eval(cleanSelector, el => el.textContent.trim());\n                    } else if (selector.includes(\'::attr(\')) {\n                        // Extract attribute\n                        const attrMatch = selector.match(/::attr\\(([^)]+)\\)/);\n                        if (attrMatch) {\n                            const attrName = attrMatch[1];\n                            const cleanSelector = selector.replace(`::attr(${attrName})`, \'\');\n                            extractedData[key] = await page.$eval(cleanSelector, (el, attr) => el.getAttribute(attr), attrName);\n                        }\n                    } else {\n                        // Default to text content\n                        extractedData[key] = await page.$eval(selector, el => el.textContent.trim());\n                    }\n                } catch (error) {\n                    console.warn(`Could not extract data for ${key}:`, error.message);\n                    extractedData[key] = null;\n                }\n            }\n        }\n        \n        // Perform actions if specified\n        if (options.actions) {\n            for (const action of options.actions) {\n                try {\n                    switch (action.type) {\n                        case \'click\':\n                            await page.click(action.selector);\n                            if (action.wait) {\n                                await page.waitForTimeout(action.wait);\n                            }\n                            break;\n                        case \'type\':\n                            await page.type(action.selector, action.text);\n                            break;\n                        case \'waitForSelector\':\n                            await page.waitForSelector(action.selector, { timeout: 10000 });\n                            break;\n                    }\n                } catch (error) {\n                    console.warn(`Could not perform action ${action.type}:`, error.message);\n                }\n            }\n        }\n        \n        // Take final screenshot\n        const finalScreenshot = await takeScreenshot(page, \'final\');\n        \n        await page.close();\n        \n        return {\n            success: true,\n            message: \'Puppeteer task completed successfully\',\n            data: extractedData,\n            screenshots: {\n                initial: initialScreenshot,\n                final: finalScreenshot\n            },\n            url: target,\n            timestamp: new Date().toISOString()\n        };\n        \n    } catch (error) {\n        console.error(\'Puppeteer task failed:\', error);\n        \n        // Try to take error screenshot\n        try {\n            if (browser) {\n                const pages = await browser.pages();\n                if (pages.length > 0) {\n                    await takeScreenshot(pages[0], \'error\');\n                }\n            }\n        } catch (screenshotError) {\n            console.warn(\'Could not take error screenshot:\', screenshotError.message);\n        }\n        \n        return {\n            success: false,\n            error: error.message,\n            message: \'Puppeteer task failed\',\n            url: target,\n            timestamp: new Date().toISOString()\n        };\n    } finally {\n        if (browser) {\n            await browser.close();\n        }\n    }\n}\n\nmodule.exports = { triggerPuppeteerTask };\n</create-file>\n</function_calls>'}