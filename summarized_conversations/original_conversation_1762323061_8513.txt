{'role': 'assistant', 'content': '<function_calls>\n<create-file file_path="HEX-Control-Nexus/backend/node_webhooks/puppeteer_tasks.js">\nconst puppeteer = require(\'puppeteer\');\nconst fs = require(\'fs\').promises;\nconst path = require(\'path\');\n\nclass PuppeteerTasks {\n    constructor() {\n        this.browser = null;\n        this.screenshotsDir = path.join(__dirname, \'..\', \'..\', \'logs\', \'screenshots\');\n        this.ensureDirectories();\n    }\n    \n    async ensureDirectories() {\n        try {\n            await fs.mkdir(this.screenshotsDir, { recursive: true });\n        } catch (error) {\n            console.warn(\'Could not create screenshots directory:\', error.message);\n        }\n    }\n    \n    async init() {\n        if (!this.browser) {\n            this.browser = await puppeteer.launch({\n                headless: true,\n                args: [\n                    \'--no-sandbox\',\n                    \'--disable-setuid-sandbox\',\n                    \'--disable-dev-shm-usage\'\n                ]\n            });\n        }\n    }\n    \n    async close() {\n        if (this.browser) {\n            await this.browser.close();\n            this.browser = null;\n        }\n    }\n    \n    async loginAndExtract(url, credentials, selectors) {\n        try {\n            await this.init();\n            const page = await this.browser.newPage();\n            \n            // Set a reasonable viewport\n            await page.setViewport({ width: 1280, height: 800 });\n            \n            // Navigate to login page\n            await page.goto(url, { waitUntil: \'networkidle2\' });\n            \n            // Fill in credentials\n            if (credentials.usernameSelector && credentials.username) {\n                await page.type(credentials.usernameSelector, credentials.username);\n            }\n            \n            if (credentials.passwordSelector && credentials.password) {\n                await page.type(credentials.passwordSelector, credentials.password);\n            }\n            \n            // Submit form\n            if (credentials.submitSelector) {\n                await page.click(credentials.submitSelector);\n                await page.waitForNavigation({ waitUntil: \'networkidle2\' });\n            }\n            \n            // Extract data\n            const data = {};\n            for (const [key, selector] of Object.entries(selectors)) {\n                try {\n                    data[key] = await page.$eval(selector, el => el.textContent.trim());\n                } catch (error) {\n                    console.warn(`Could not extract data for ${key}:`, error.message);\n                    data[key] = null;\n                }\n            }\n            \n            // Take screenshot\n            const timestamp = new Date().toISOString().replace(/[:.]/g, \'-\');\n            const screenshotPath = path.join(this.screenshotsDir, `login_success_${timestamp}.png`);\n            await page.screenshot({ path: screenshotPath, fullPage: true });\n            \n            await page.close();\n            return { success: true, data, screenshot: screenshotPath };\n        } catch (error) {\n            console.error(\'Login and extract failed:\', error);\n            \n            // Try to take error screenshot\n            try {\n                const pages = await this.browser.pages();\n                if (pages.length > 0) {\n                    const timestamp = new Date().toISOString().replace(/[:.]/g, \'-\');\n                    const screenshotPath = path.join(this.screenshotsDir, `login_error_${timestamp}.png`);\n                    await pages[0].screenshot({ path: screenshotPath, fullPage: true });\n                }\n            } catch (screenshotError) {\n                console.warn(\'Could not take error screenshot:\', screenshotError.message);\n            }\n            \n            return { success: false, error: error.message };\n        }\n    }\n    \n    async navigateAndExtract(url, actions, selectors) {\n        try {\n            await this.init();\n            const page = await this.browser.newPage();\n            \n            await page.setViewport({ width: 1280, height: 800 });\n            await page.goto(url, { waitUntil: \'networkidle2\' });\n            \n            // Perform actions\n            for (const action of actions) {\n                switch (action.type) {\n                    case \'click\':\n                        await page.click(action.selector);\n                        if (action.waitAfter) {\n                            await page.waitForTimeout(action.waitAfter);\n                        }\n                        break;\n                    case \'type\':\n                        await page.type(action.selector, action.value);\n                        break;\n                    case \'waitForSelector\':\n                        await page.waitForSelector(action.selector, { timeout: 10000 });\n                        break;\n                }\n            }\n            \n            // Extract data\n            const data = {};\n            for (const [key, selector] of Object.entries(selectors)) {\n                try {\n                    const elements = await page.$$(selector);\n                    if (elements.length > 1) {\n                        // Multiple elements - extract text from all\n                        data[key] = await Promise.all(\n                            elements.map(el => el.evaluate(el => el.textContent.trim()))\n                        );\n                    } else if (elements.length === 1) {\n                        // Single element\n                        data[key] = await elements[0].evaluate(el => el.textContent.trim());\n                    } else {\n                        data[key] = null;\n                    }\n                } catch (error) {\n                    console.warn(`Could not extract data for ${key}:`, error.message);\n                    data[key] = null;\n                }\n            }\n            \n            // Take screenshot\n            const timestamp = new Date().toISOString().replace(/[:.]/g, \'-\');\n            const screenshotPath = path.join(this.screenshotsDir, `navigate_success_${timestamp}.png`);\n            await page.screenshot({ path: screenshotPath, fullPage: true });\n            \n            await page.close();\n            return { success: true, data, screenshot: screenshotPath };\n        } catch (error) {\n            console.error(\'Navigate and extract failed:\', error);\n            \n            // Try to take error screenshot\n            try {\n                const pages = await this.browser.pages();\n                if (pages.length > 0) {\n                    const timestamp = new Date().toISOString().replace(/[:.]/g, \'-\');\n                    const screenshotPath = path.join(this.screenshotsDir, `navigate_error_${timestamp}.png`);\n                    await pages[0].screenshot({ path: screenshotPath, fullPage: true });\n                }\n            } catch (screenshotError) {\n                console.warn(\'Could not take error screenshot:\', screenshotError.message);\n            }\n            \n            return { success: false, error: error.message };\n        }\n    }\n    \n    async scrapeQuotesPage(url) {\n        try {\n            await this.init();\n            const page = await this.browser.newPage();\n            \n            await page.setViewport({ width: 1280, height: 800 });\n            await page.goto(url, { waitUntil: \'networkidle2\' });\n            \n            // Extract quotes\n            const quotes = await page.evaluate(() => {\n                const quoteElements = document.querySelectorAll(\'.quote\');\n                return Array.from(quoteElements).map(quoteEl => {\n                    return {\n                        text: quoteEl.querySelector(\'.text\')?.textContent?.trim() || \'\',\n                        author: quoteEl.querySelector(\'.author\')?.textContent?.trim() || \'\',\n                        tags: Array.from(quoteEl.querySelectorAll(\'.tags .tag\'))\n                                  .map(tag => tag.textContent.trim())\n                    };\n                });\n            });\n            \n            // Take screenshot\n            const timestamp = new Date().toISOString().replace(/[:.]/g, \'-\');\n            const screenshotPath = path.join(this.screenshotsDir, `quotes_${timestamp}.png`);\n            await page.screenshot({ path: screenshotPath, fullPage: true });\n            \n            await page.close();\n            return { success: true, data: quotes, screenshot: screenshotPath };\n        } catch (error) {\n            console.error(\'Scrape quotes failed:\', error);\n            return { success: false, error: error.message };\n        }\n    }\n}\n\nmodule.exports = PuppeteerTasks;\n</create-file>\n</function_calls>'}